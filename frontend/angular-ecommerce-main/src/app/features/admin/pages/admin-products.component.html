<section class="p-6 space-y-4">
  <!-- Toast (render khi visible) -->
  <div *ngIf="toastVisible"
       class="fixed right-4 top-4 z-[9999] transition-all duration-300 ease-in-out translate-x-0 opacity-100">
    <div class="min-w-[240px] max-w-[360px] px-3 py-2 rounded shadow text-white text-sm"
         [ngClass]="{
            'bg-green-600': toastType==='success',
            'bg-rose-600': toastType==='error',
            'bg-slate-800': toastType==='info'
         }">
      {{ toastMsg }}
    </div>
  </div>

  <div class="flex flex-wrap items-center justify-between gap-3">
    <h2 class="text-xl font-bold">üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>

    <div class="flex items-center gap-2">
      <a routerLink="/dashboard/products/new"
         class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:opacity-90">+ Th√™m m·ªõi</a>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white border rounded-xl p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-3">
      <input [(ngModel)]="keyword" (keyup.enter)="searchNow()"
             placeholder="T√¨m theo t√™n / SKU / slug..."
             class="border rounded-lg px-3 py-2">

      <select [(ngModel)]="categoryId" class="border rounded-lg px-3 py-2">
        <option [ngValue]="undefined">‚Äî T·∫•t c·∫£ danh m·ª•c ‚Äî</option>
        <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.name }}</option>
      </select>

      <select [(ngModel)]="enabled" class="border rounded-lg px-3 py-2">
        <option [ngValue]="undefined">‚Äî Tr·∫°ng th√°i ‚Äî</option>
        <option [ngValue]="true">On</option>
        <option [ngValue]="false">Off</option>
      </select>

      <select [(ngModel)]="inStock" class="border rounded-lg px-3 py-2">
        <option [ngValue]="undefined">‚Äî T·ªìn kho ‚Äî</option>
        <option [ngValue]="true">C√≤n h√†ng (&gt; 0)</option>
        <option [ngValue]="false">H·∫øt h√†ng (‚â§ 0)</option>
      </select>

      <input [(ngModel)]="minPrice" type="number" min="0" placeholder="Gi√° t·ªëi thi·ªÉu"
             class="border rounded-lg px-3 py-2">
      <input [(ngModel)]="maxPrice" type="number" min="0" placeholder="Gi√° t·ªëi ƒëa"
             class="border rounded-lg px-3 py-2">
    </div>

    <div class="mt-3 flex flex-wrap items-center gap-2">
      <button (click)="searchNow()"
              class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">T√¨m</button>
      <button (click)="clearFilters()"
              class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">Xo√° l·ªçc</button>

      <div class="ml-auto flex items-center gap-2">
        <label class="text-sm">S·∫Øp x·∫øp:</label>
        <select [(ngModel)]="sort" (change)="page=0; load()" class="border rounded px-2 py-1">
          <option value="id,desc">ID ‚Üì</option>
          <option value="id,asc">ID ‚Üë</option>
          <option value="name,asc">T√™n ‚Üë</option>
          <option value="name,desc">T√™n ‚Üì</option>
          <option value="price,asc">Gi√° ‚Üë</option>
          <option value="price,desc">Gi√° ‚Üì</option>
          <option value="stock,asc">Kho ‚Üë</option>
          <option value="stock,desc">Kho ‚Üì</option>
          <option value="createdAt,desc">T·∫°o ‚Üì</option>
          <option value="createdAt,asc">T·∫°o ‚Üë</option>
          <option value="updatedAt,desc">C·∫≠p nh·∫≠t ‚Üì</option>
          <option value="updatedAt,asc">C·∫≠p nh·∫≠t ‚Üë</option>
        </select>

        <label class="text-sm">Page size:</label>
        <select [(ngModel)]="size" (change)="page=0; load()" class="border rounded px-2 py-1">
          <option [ngValue]="10">10</option>
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto border rounded-xl bg-white">
    <table class="w-full min-w-[1100px] border-collapse">
      <thead>
        <tr class="bg-slate-50 text-left text-sm">
          <th class="p-3 border cursor-pointer" (click)="changeSort('id')">ID</th>
          <th class="p-3 border">·∫¢nh</th>
          <th class="p-3 border cursor-pointer" (click)="changeSort('name')">T√™n / SKU / Slug</th>
          <th class="p-3 border">Danh m·ª•c</th>
          <th class="p-3 border cursor-pointer" (click)="changeSort('price')">Gi√°</th>
          <th class="p-3 border cursor-pointer" (click)="changeSort('stock')">Kho</th>
          <th class="p-3 border">TT</th>
          <th class="p-3 border">Chi ti·∫øt ·∫£nh</th>
          <th class="p-3 border cursor-pointer" (click)="changeSort('createdAt')">T·∫°o</th>
          <th class="p-3 border cursor-pointer" (click)="changeSort('updatedAt')">C·∫≠p nh·∫≠t</th>
          <th class="p-3 border">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="loading">
          <td colspan="11" class="p-6 text-center text-slate-500">ƒêang t·∫£i...</td>
        </tr>

        <tr *ngIf="!loading && error">
          <td colspan="11" class="p-6 text-center text-rose-600">{{ error }}</td>
        </tr>

        <tr *ngFor="let p of data; trackBy: trackById" class="hover:bg-slate-50 align-top">
          <td class="p-3 border">{{ p.id }}</td>

          <td class="p-3 border">
            <div class="w-16 h-16 bg-slate-100 rounded overflow-hidden grid place-content-center">
              <img *ngIf="p.coverImage"
                   [src]="getImageUrl(p.coverImage!)"
                   class="w-full h-full object-cover" alt="cover">
              <span *ngIf="!p.coverImage" class="text-xs text-slate-400">No img</span>
            </div>
          </td>

          <td class="p-3 border">
            <div class="font-medium">{{ p.name }}</div>
            <div class="text-xs text-slate-500">SKU: <span class="font-mono">{{ p.sku }}</span></div>
            <div class="text-xs text-slate-500">Slug: <span class="font-mono">{{ p.slug }}</span></div>
            <div class="text-xs text-slate-500 mt-1 line-clamp-2" *ngIf="p.description">{{ p.description }}</div>
          </td>

          <td class="p-3 border">{{ p.category?.name || '‚Äî' }}</td>

          <td class="p-3 border">
            <div class="font-medium">{{ fmtMoney(p.price, p.currency) }}</div>
            <div *ngIf="p.previousPrice && p.previousPrice > p.price" class="text-xs text-slate-500 mt-0.5">
              <s>{{ fmtMoney(p.previousPrice!, p.currency) }}</s>
              <span class="ml-1 px-1.5 py-0.5 text-xs rounded bg-green-100 text-green-700"
                    *ngIf="percentOff(p)">
                -{{ percentOff(p) }}
              </span>
            </div>
          </td>

          <td class="p-3 border">{{ p.stock }}</td>

          <td class="p-3 border">
            <span class="px-2 py-0.5 rounded text-xs"
                  [class.bg-green-100]="p.enabled"
                  [class.text-green-700]="p.enabled"
                  [class.bg-red-100]="!p.enabled"
                  [class.text-red-700]="!p.enabled">
              {{ p.enabled ? 'On' : 'Off' }}
            </span>
          </td>

          <td class="p-3 border">
            <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-xs">
              {{ detailsCount(p) }} ·∫£nh
            </span>
          </td>

          <td class="p-3 border text-sm text-slate-600">{{ fmtDate(p.createdAt) }}</td>
          <td class="p-3 border text-sm text-slate-600">{{ fmtDate(p.updatedAt) }}</td>

          <td class="p-3 border whitespace-nowrap space-x-3">
            <a [routerLink]="['/dashboard','products','edit', p.id]"
               class="text-blue-600 hover:underline">S·ª≠a</a>
            <button (click)="openDeleteModal(p.id!)" class="text-red-600 hover:underline">Xo√°</button>
          </td>
        </tr>

        <tr *ngIf="!loading && !error && !data.length">
          <td colspan="11" class="p-6 text-center text-slate-500">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="text-sm text-slate-600">
      T·ªïng: <b>{{ totalElements }}</b> ‚Äî Trang {{ page + 1 }}/{{ totalPages || 1 }}
    </div>

    <div class="flex items-center gap-2">
      <button class="px-3 py-1.5 border rounded disabled:opacity-50"
              (click)="gotoPage(page - 1)" [disabled]="page <= 0">‚Üê Prev</button>
      <button class="px-3 py-1.5 border rounded disabled:opacity-50"
              (click)="gotoPage(page + 1)" [disabled]="page + 1 >= totalPages">Next ‚Üí</button>
    </div>
  </div>

  <!-- Modal Xo√° -->
  <div *ngIf="showDeleteModal" class="fixed inset-0 z-[999]">
    <div class="absolute inset-0 bg-black/50" (click)="closeDeleteModal()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-[360px] max-w-full p-5 animate-[fadeIn_.18s_ease]">
        <h3 class="text-lg font-semibold mb-2">X√°c nh·∫≠n xo√°</h3>
        <p class="text-sm text-slate-600 mb-4">
          B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° s·∫£n ph·∫©m n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.
        </p>
        <div class="flex justify-end gap-2">
          <button (click)="closeDeleteModal()"
                  class="px-3 py-1.5 rounded border bg-white hover:bg-slate-50">Hu·ª∑</button>
          <button (click)="confirmDelete()"
                  [disabled]="deletingLoading"
                  class="px-3 py-1.5 rounded bg-red-600 text-white disabled:opacity-60 hover:bg-red-700">
            {{ deletingLoading ? 'ƒêang xo√°‚Ä¶' : 'Xo√°' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
