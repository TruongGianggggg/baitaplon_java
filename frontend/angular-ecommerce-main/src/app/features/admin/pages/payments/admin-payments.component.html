<!-- src/app/pages/admin/payments/admin-payments.component.html -->
<section class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="flex items-center justify-between gap-3">
    <h1 class="text-2xl font-semibold">Quản trị · Tất cả thanh toán</h1>
    <button
      class="px-3 py-2 border rounded hover:bg-gray-50 disabled:opacity-60"
      (click)="reload()"
      [disabled]="loadingList"
      aria-label="Làm mới"
    >
      {{ loadingList ? 'Đang tải...' : '↻ Làm mới' }}
    </button>
  </div>

  <!-- Error -->
  <div *ngIf="errorList" class="mt-3 text-sm text-rose-700 bg-rose-50 border border-rose-200 rounded p-3">
    {{ errorList }}
  </div>

  <!-- Table -->
  <div class="mt-4 overflow-x-auto rounded-xl border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 sticky top-0 z-10">
        <tr>
          <th class="p-2 text-left border-b">ID</th>
          <th class="p-2 text-left border-b">Order</th>
          <th class="p-2 text-left border-b">Số tiền</th>
          <th class="p-2 text-left border-b">Phương thức</th>
          <th class="p-2 text-left border-b">Trạng thái</th>
          <th class="p-2 text-left border-b">TxnRef</th>
          <th class="p-2 text-left border-b w-32">Chi tiết</th>
        </tr>
      </thead>

      <tbody>
        <!-- Dòng dữ liệu -->
        <tr *ngFor="let p of payments; trackBy: trackById" class="hover:bg-gray-50">
          <td class="p-2 border-b whitespace-nowrap font-medium">#{{ p.id }}</td>
          <td class="p-2 border-b whitespace-nowrap">#{{ p.orderId ?? '—' }}</td>
          <td class="p-2 border-b whitespace-nowrap">{{ p.amount | number:'1.0-0' }} đ</td>
          <td class="p-2 border-b">
            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs border bg-white">
              {{ p.method || '—' }}
            </span>
          </td>
          <td class="p-2 border-b">
            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs border" [ngClass]="statusClass(p.status)">
              {{ p.status }}
            </span>
          </td>
          <td class="p-2 border-b max-w-[220px]">
            <span class="font-mono text-xs truncate block" [title]="p.txnRef || '—'">{{ p.txnRef || '—' }}</span>
          </td>
          <td class="p-2 border-b">
            <button
              class="w-full md:w-auto text-center px-2 py-1 border rounded text-sm hover:bg-gray-50 disabled:opacity-60"
              (click)="viewDetail(p.id)"
              [disabled]="loadingDetail && selected?.id === p.id"
            >
              {{ (loadingDetail && selected?.id === p.id) ? 'Đang mở...' : 'Xem' }}
            </button>
          </td>
        </tr>

        <!-- Empty -->
        <tr *ngIf="payments.length === 0 && !loadingList">
          <td class="p-6 text-center text-gray-500" colspan="7">
            Chưa có thanh toán
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== MODAL CHI TIẾT PAYMENT ===== -->
  <div *ngIf="selected" class="fixed inset-0 z-[60]" (keydown.escape)="selected = null" tabindex="0" autofocus>
    <!-- Nền mờ -->
    <div class="absolute inset-0 bg-black/40 backdrop-blur-[1px]" (click)="selected = null"></div>

    <!-- Panel -->
    <div class="absolute inset-0 flex items-center justify-center p-4" (click)="selected = null">
      <div
        class="w-full max-w-2xl bg-white rounded-2xl border shadow-2xl"
        role="dialog"
        aria-modal="true"
        aria-labelledby="payment-detail-title"
        (click)="$event.stopPropagation()"
      >
        <!-- Header -->
        <div class="flex items-center justify-between px-5 py-4 border-b">
          <h2 id="payment-detail-title" class="text-lg md:text-xl font-semibold">
            Chi tiết Payment #{{ selected.id }}
          </h2>
          <button
            class="inline-flex items-center justify-center w-8 h-8 rounded-lg hover:bg-gray-100"
            (click)="selected = null"
            aria-label="Đóng"
            title="Đóng"
          >
            ✕
          </button>
        </div>

        <!-- Body -->
        <div class="px-5 py-4 space-y-4">
          <div class="grid md:grid-cols-2 gap-3 text-sm">
            <div><b>Order:</b> #{{ selected.orderId ?? '—' }}</div>
            <div><b>Số tiền:</b> {{ selected.amount | number:'1.0-0' }} đ</div>

            <div>
              <b>Phương thức:</b>
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs border bg-white">
                {{ selected.method || '—' }}
              </span>
            </div>

            <div>
              <b>Trạng thái:</b>
              <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs border" [ngClass]="statusClass(selected.status)">
                {{ selected.status }}
              </span>
            </div>

            <div><b>Provider:</b> {{ selected.provider || '—' }}</div>
            <div><b>TxnRef:</b> <span class="font-mono text-xs break-all">{{ selected.txnRef || '—' }}</span></div>

            <div><b>BankCode:</b> <span class="font-mono text-xs break-all">{{ selected.bankCode || '—' }}</span></div>
            <div><b>BankTranNo:</b> <span class="font-mono text-xs break-all">{{ selected.bankTranNo || '—' }}</span></div>

            <div><b>TransactionNo:</b> <span class="font-mono text-xs break-all">{{ selected.transactionNo || '—' }}</span></div>
            <div><b>ResponseCode:</b> <span class="font-mono text-xs break-all">{{ selected.responseCode || '—' }}</span></div>

            <div class="md:col-span-2">
              <b>OrderInfo:</b>
              <span class="block break-words">{{ selected.orderInfo || '—' }}</span>
            </div>

            <div class="md:col-span-2">
              <b>Thời gian:</b>
              {{ (selected.payDate || selected.createdAt) | date:'short' }}
            </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center justify-end gap-2 pt-2">
            <button class="px-3 py-2 border rounded-lg hover:bg-gray-50" (click)="selected = null">
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ===== END MODAL ===== -->
</section>
